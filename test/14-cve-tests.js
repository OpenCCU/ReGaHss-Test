/* global describe, it */
/* eslint-disable no-unused-vars, import/no-unassigned-import, max-nested-callbacks, prefer-arrow-callback, capitalized-comments */

const path = require('path');
const fs = require('fs');
const async = require('async');
const request = require('request');

const {
    cp,
    rega,
    subscribe,
    procs,
    simSubscriptions,
    simBuffer,
    regaSubscriptions,
    regaBuffer,
    flavors,
    indent,
    initTest,
    cleanupTest
} = require('../lib/helper.js');

require('should');

function fromDir(startPath, filter, callback) {
    if (!fs.existsSync(startPath)) {
        console.log('no dir_', startPath);
        return;
    }

    const files = fs.readdirSync(startPath);
    for (const file of files) {
        const filename = path.join(startPath, file);
        const stat = fs.lstatSync(filename);
        if (stat.isDirectory()) {
            if (fromDir(filename, filter, callback) === false) {
                return false;
            }
        } else if (filter.test(filename) && callback(filename) === false) {
            return false;
        }
    }

    return true;
}

flavors.forEach(function (flavor) {
    describe('Running ' + __filename.split('/').reverse()[0] + ' [' + flavor + ']', function () {
        // initialize test environment
        initTest(flavor, false);

        describe('testing for fixed CVE/security issues...', function () {
            it('CVE-2019-9726 (NUL-byte URL request vulnerability)', function (done) {
                this.timeout(30000);
                request('http://127.0.0.1:8183/.%00./.%00./etc/config/homematic.regadom', function (error, response, body) {
                    if (error) {
                        done(error);
                    } else if (body.includes('<name>DOM</name>')) {
                        done(new Error('could retrieve whole homematic.regadom'));
                    } else if (body === 'Not Found') {
                        done();
                    } else {
                        done(new Error('webserver did not reply with "Not Found"'));
                    }
                });
            });

            it('CVE-2019-9583 (session id exposure)', function (done) {
                this.timeout(60000);
                const urlArray = [];
                fromDir('/www', /\.(htm|html|cgi)$/, function (filename) {
                    const urlpath = filename.replace(/^\/www/, '').replace(/^\/rega/, '');
                    urlArray.push(urlpath);
                });
                let counter = 0;
                async.whilst(
                    function (cb) {
                        cb(null, counter < urlArray.length);
                    },
                    function (callback) {
                        const rec = urlArray[counter++];
                        request({url: 'http://127.0.0.1:8183' + rec, followRedirect: false}, function (error, response, body) {
                            if (error) {
                                callback(error, counter);
                            } else if (typeof (response.headers.location) !== 'undefined' &&
                                       response.headers.location.includes('sid=@')) {
                                callback(new Error(rec + ' returned vulerable Location: header with sid=@@ (' + response.headers.location + ')'), counter);
                            } else {
                                callback(null, counter);
                            }
                        });
                    },
                    function (error, n) {
                        if (error) {
                            done(error);
                        } else {
                            done();
                        }
                    }
                );
            });

            it('CVE-2019-14474 (unexpected Call("") crash)', function (done) {
                this.timeout(30000);
                rega.exec(`
WriteLine("before");
Call("");
WriteLine("after");
                `, function (error, output, objects) {
                    if (error) {
                        done(error);
                    } else {
                        output.should.equal('before\r\nafter\r\n');
                        done();
                    }
                });
            });

            it('POST request session-less vulnerability (body)', function (done) {
                this.timeout(30000);
                request.post({url: 'http://127.0.0.1:8183/esp/system.htm', body: 'WriteLine("1234");', followRedirect: false}, function (error, response, body) {
                    if (error) {
                        done(error);
                    } else {
                        body.should.equal('');
                        done();
                    }
                });
            });

            it('POST request session-less vulnerability (root body)', function (done) {
                this.timeout(30000);
                request.post({url: 'http://127.0.0.1:8183/', body: 'WriteLine("1234");', followRedirect: false}, function (error, response, body) {
                    if (error) {
                        done(error);
                    } else {
                        body.should.not.containEql('1234\r\n');
                        done();
                    }
                });
            });

            it('POST request session-less vulnerability (url params)', function (done) {
                this.timeout(30000);
                request.post({url: 'http://127.0.0.1:8183/esp/system.htm?action=%22TestRunning%22%3B', body: '0815', followRedirect: false}, function (error, response, body) {
                    if (error) {
                        done(error);
                    } else {
                        response.statusCode.should.equal(302);
                        done();
                    }
                });
            });
        });

        // cleanup test environment
        cleanupTest(flavor);
    });
});
